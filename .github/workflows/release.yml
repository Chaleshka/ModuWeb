name: Release Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g. v1.1.0) â€” tag will be created as v1.1.0"
        required: true
        type: string
      release_title:
        description: "Release title (e.g. SSE support, Razor views)"
        required: true
        type: string
      release_description:
        description: "Release description (commit list will be appended automatically)"
        required: false
        type: string
        default: ""
      prerelease:
        description: "Mark as pre-release (beta/test)"
        required: false
        type: boolean
        default: false

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            aot: true
            archive: zip
          - os: ubuntu-latest
            rid: linux-x64
            aot: true
            archive: tar
          - os: ubuntu-latest
            rid: linux-arm64
            aot: false
            archive: tar

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Publish
        run: >
          dotnet publish ModuWeb.csproj
          -c Release
          -r ${{ matrix.rid }}
          --self-contained true
          -p:PublishAot=${{ matrix.aot }}
          -p:DebugType=none
          -p:DebugSymbols=false
          -o ./publish

      - name: Clean publish output (Linux)
        if: runner.os == 'Linux'
        run: find ./publish -name "*.pdb" -o -name "*.xml" -o -name "*.deps.json" | xargs rm -f

      - name: Clean publish output (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Get-ChildItem ./publish -Include *.pdb,*.xml,*.deps.json -Recurse | Remove-Item -Force

      - name: Package (zip)
        if: matrix.archive == 'zip'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path ./output
          Compress-Archive -Path ./publish/* -DestinationPath "./output/ModuWeb-${{ matrix.rid }}-${{ inputs.version }}.zip"

      - name: Package (tar.gz)
        if: matrix.archive == 'tar'
        run: |
          mkdir -p ./output
          tar -czf "./output/ModuWeb-${{ matrix.rid }}-${{ inputs.version }}.tar.gz" -C ./publish .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ModuWeb-${{ matrix.rid }}
          path: ./output/*

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            COMMITS=$(git log --oneline --no-decorate)
          else
            COMMITS=$(git log --oneline --no-decorate "${PREV_TAG}..HEAD")
          fi

          BODY="${{ inputs.release_description }}"
          if [ -n "$BODY" ]; then
            BODY="${BODY}"$'\n\n'
          fi
          BODY="${BODY}## Commits"$'\n'"${COMMITS}"

          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "body<<$EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Create tag
        run: |
          git tag "${{ inputs.version }}"
          git push origin "${{ inputs.version }}"

      - name: Create Draft Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "${{ inputs.version }}"
          name: "${{ inputs.release_title }}"
          body: ${{ steps.changelog.outputs.body }}
          draft: true
          prerelease: ${{ inputs.prerelease }}
          files: ./artifacts/*
